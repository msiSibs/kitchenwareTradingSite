{% extends 'base.html' %}

{% block title %}Edit Item - Kitchenware Marketplace{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-edit"></i> Edit Listing</h3>
                </div>
                <div class="card-body p-5">
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <!-- Title -->
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Title *</label>
                            {{ form.title }}
                            <small class="form-text text-muted d-block mt-1">
                                {{ form.title.help_text|safe }}
                            </small>
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
                            {{ form.description }}
                            <small class="form-text text-muted d-block mt-1">
                                {{ form.description.help_text|safe }}
                            </small>
                            {% if form.description.errors %}
                                <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Category -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">Category *</label>
                                    {{ form.category }}
                                    <small class="form-text text-muted d-block mt-1">
                                        {{ form.category.help_text|safe }}
                                    </small>
                                    {% if form.category.errors %}
                                        <div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Price -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.price.id_for_label }}" class="form-label">Price *</label>
                                    {{ form.price }}
                                    <small class="form-text text-muted d-block mt-1">
                                        {{ form.price.help_text|safe }}
                                    </small>
                                    {% if form.price.errors %}
                                        <div class="text-danger small mt-1">{{ form.price.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Condition -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.condition.id_for_label }}" class="form-label">Condition *</label>
                                    {{ form.condition }}
                                    <small class="form-text text-muted d-block mt-1">
                                        {{ form.condition.help_text|safe }}
                                    </small>
                                    {% if form.condition.errors %}
                                        <div class="text-danger small mt-1">{{ form.condition.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Brand -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.brand.id_for_label }}" class="form-label">Brand</label>
                                    {{ form.brand }}
                                    <small class="form-text text-muted d-block mt-1">
                                        {{ form.brand.help_text|safe }}
                                    </small>
                                    {% if form.brand.errors %}
                                        <div class="text-danger small mt-1">{{ form.brand.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Material -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.material.id_for_label }}" class="form-label">Material</label>
                                    {{ form.material }}
                                    <small class="form-text text-muted d-block mt-1">
                                        {{ form.material.help_text|safe }}
                                    </small>
                                    {% if form.material.errors %}
                                        <div class="text-danger small mt-1">{{ form.material.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Location -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.location.id_for_label }}" class="form-label">Location *</label>
                                    {{ form.location }}
                                    <small class="form-text text-muted d-block mt-1">
                                        {{ form.location.help_text|safe }}
                                    </small>
                                    {% if form.location.errors %}
                                        <div class="text-danger small mt-1">{{ form.location.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Existing Images -->
                        {% if existing_images %}
                            <div class="mb-4">
                                <label class="form-label">Current Images</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% for image in existing_images %}
                                        <div class="position-relative">
                                            <img src="{{ image.image.url }}" 
                                                 alt="{{ image.item.title }}"
                                                 style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
                                            {% if image.is_primary %}
                                                <span class="badge bg-success position-absolute top-0 start-0 m-1">Primary</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Add More Images -->
                        <div class="mb-3">
                            <label for="id_images" class="form-label">Add More Product Images</label>
                            <input type="file" 
                                   id="id_images" 
                                   name="images" 
                                   multiple 
                                   accept="image/jpeg,image/png,image/gif,image/webp" 
                                   class="form-control">
                            <small class="form-text text-muted d-block mt-1">
                                Add additional product images (JPG, PNG, GIF, WebP). Max 5MB per image.
                            </small>
                            <div id="imagePreview" class="mt-3 d-flex gap-2 flex-wrap"></div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2 pt-3">
                            <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <a href="{% url 'marketplace:detail' object.pk %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>

                    <script>
                        // Image preview on select
                        document.getElementById('id_images').addEventListener('change', function(e) {
                            const preview = document.getElementById('imagePreview');
                            preview.innerHTML = '';
                            
                            for (let file of this.files) {
                                const reader = new FileReader();
                                reader.onload = function(event) {
                                    const img = document.createElement('img');
                                    img.src = event.target.result;
                                    img.style.width = '80px';
                                    img.style.height = '80px';
                                    img.style.objectFit = 'cover';
                                    img.style.borderRadius = '4px';
                                    img.style.border = '1px solid #ddd';
                                    preview.appendChild(img);
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
